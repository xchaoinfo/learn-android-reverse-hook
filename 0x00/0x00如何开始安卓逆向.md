# 如何开始安卓逆向

> 不积跬步无以至千里，不积小流无以成江河

## 安卓逆向对抗历史碎碎念

在开始安卓逆向之前，需要对安卓的逆向对抗的历史有一些了解。

从普通用户的角度来看, 安卓从4.4版本开始，才算是一个勉强可用的操作系统，但从逆向的角度来看，安卓从7.0开始才算是开始在安全性方面有所建树。在安卓7.0之前各种*花活*可以玩的不亦乐乎。但是随着安卓生态的完善，对安卓APP的逆向分析难度是不断变大的。

在我看来，Android逆向的难度变大，主要原因如下:
1. Android 系统自身的安全策略，随着版本升级逐步完善。
2. 混淆和加壳等技术的成熟，使得免费版的加固方案也很好的安全性。
3. Android App的个人开发减少，大公司开发的App更有动力做安全加固。


## 从拿到一个Android安装包开始

当你从网上下载了一个Android安装包，你发现是一个`.apk`结尾的文件，你需要知道`.apk`文件是什么格式的，里面有什么内容，有哪些对抗的方式。

### apk文件是什么格式的
> APK（全称：Android application package，Android应用程序包）是Android操作系统使用的一种应用程序包文件格式，用于分发和安装移动应用及中间件。
从逆向分析的角度来看，APK文件更像是一个压缩包，你可以把文件后缀改为.zip，然后使用解压软件打开。

### APK里面有什么内容

对于不同的开发模式和Android版本来说，APK文件里面内容是略有差异的，但是一般情况下，都有如下的内容
- AndroidManifest.xml 安装包的核心配置文件，记录了包名、应用名、权限等配置。android低版本的时候就是xml的纯文本，高版本的安卓是 axml格式的
- classes*.dex 可能会有一个到多个dex文件，包好了java或kotlin编译后的二进制文件，这个逆向分析的重点
- assets文件夹， 保存了一些静态的文件，如果是uniapp开发应用，可能会有一些重要的js源码
- lib文件夹 保存了不同平台的Linux平台的.so文件, 是标准的ELF格式的，一般是ARM架构的。重要反调式和加密函数一般会在.so文件中，也是逆向分析的重点
- 其他文件，一些签名和配置文件等，对开发来说很重要，但不是逆向关注的重点。

### 逆向与对抗的方式

#### 破坏压缩包格式来对抗逆向

apk文件类似于一个压缩包，逆向分析软件是通过先解压然后在进行分析的， 这个时候对apk文件做一些细微的改动，如改动压缩包的标识符，加入一些乱码的字符，从而达到apk文件可正常安装，但是无法使用逆向分析工具来分析。看雪论坛的这篇文章有相关的介绍
https://bbs.kanxue.com/thread-272045.htm

这种较为初级的对抗很多黑灰产的APP在使用，目的是为了逃避自动化的apk检测系统。对于逆向分析人员来说，使用binwalk提取文件或者使用`010 Editor`修复格式，然后提取文件分析即可。 

#### 代码层来对抗逆向

dex文件
1. 把方法名称混淆成abcd无意义的字符，更恶心的混淆成火星文，分析难度加倍, 只能耐心硬上，无通用解决方案。
2. 加壳，分为一代二代三代壳，一代二代壳基本动态分析可解决，三代壳看运气了。

so文件
1. 去掉符号表、混淆命名, 可通过函数签名解决部分, ida Pro和Ghidra都有类似的功能
2. 字符偏移，动态分析可解，难度较大
3. 反调试，动态分析可解，难度看运气



## 工具与技能

### 工具
静态分析工具有很多，但是目前最好用的就是 Jadx,对于.so文件的分析比较好用的就是 IDA PRO和 Ghidra

动态分析，一般使用Frida来hook。

抓包分析工具，我一般使用 Mitmproxy(支持的代理模式多，功能强大，可通过Python写插件非常方便）

### 技能

从编程语言来说，至少对JAVA/Kotlin/Python/C/JavaScript都要有所了解，并且熟悉一门编程语言。例如本人就比较熟悉Python，并且能在搜索引擎帮助下看懂和写其他几门语言

从安卓系统来说，要对安卓开发有所了解，并且需要会配置各种环境。

更重要的是善用搜索引擎，逆向和对抗时刻变化，动态平衡中。



未完待续！




